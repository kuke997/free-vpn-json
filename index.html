import yaml
import json
import os

INPUT_YAML = "raw_nodes.yaml"
OUTPUT_JSON = os.path.join("public", "vpn_nodes.json")

def main():
    if not os.path.exists(INPUT_YAML):
        print(f"Error: {INPUT_YAML} not found.")
        return

    with open(INPUT_YAML, "r", encoding="utf-8") as f:
        nodes = yaml.safe_load(f)

    if not isinstance(nodes, list):
        print(f"Error: Expected a list in {INPUT_YAML}, got {type(nodes)}")
        return

    output = []
    for i, node in enumerate(nodes):
        if not isinstance(node, dict):
            print(f"Warning: Skipping item {i} because it's not a dict: {node}")
            continue
        server = node.get("server")
        port = node.get("port")
        country = node.get("country", "Unknown")
        if not server or not port:
            # 忽略无效节点
            continue
        output.append({
            "country": country,
            "server": server,
            "port": port
        })

    os.makedirs(os.path.dirname(OUTPUT_JSON), exist_ok=True)
    with open(OUTPUT_JSON, "w", encoding="utf-8") as f:
        json.dump(output, f, ensure_ascii=False, indent=2)

    print(f"Converted {len(output)} valid VPN nodes to {OUTPUT_JSON}")

if __name__ == "__main__":
    main()
